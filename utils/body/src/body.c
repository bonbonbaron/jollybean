#include "body.h"

int main(int argc, char ** argv) {
  char *srcFilePath;
  Directory *cpDirP, *cmDirP;
  U32 origNColorPalettes, origNCollisionTypes, origNColormaps;
  cpDirP = cmDirP = NULL;

  // Verbose 
  U8 verbose = 0;

  // Directories
  Error e = dirGet(&cpDirP, "ColorPalette", argc, verbose);
  if (!e) {
    e = dirGet(&cmDirP, "Colormap", argc, verbose);
  }
  if (!e) {
    origNColorPalettes = cpDirP->nEntries;
    origNColormaps = cmDirP->nEntries;
    origNColorPalettes = origNColormaps = 0;
  }

  // Write all the bodies.
  for (U32 i = 1; !e && i < argc; ++i) {
    if (!strcmp(argv[i], "-v")) {
      verbose = 1;
      continue;
    }
    // Colormap and Color palette (autogenerated)
    e = getSrcFilePath(&srcFilePath, "Body/Graybody/Colormap/", argv[i]); 
    if (!e) {
      e = img(srcFilePath, cpDirP, cmDirP, verbose);
    }
    jbFree((void**) &srcFilePath);
    // Animation
    Animation *animP = NULL;
    if (!e) {
      e = getSrcFilePath(&srcFilePath, "Body/Graybody/Animation/", argv[i]); 
    }
    if (!e) {
      e = anim (srcFilePath, verbose, &animP);
    }
    jbFree((void**) &srcFilePath);
    // Collision
    if (!e) {
      e = getSrcFilePath(&srcFilePath, "Body/Graybody/Collision/", argv[i]); 
    }
    if (!e) {
      e = coll(srcFilePath, 0, animP, verbose);
    }
    jbFree((void**) &animP);
    jbFree((void**) &srcFilePath);
    // Genome
    // Seed
  }

  // Save the updated palette directory AFTER all updates are done.
  if (!e && cpDirP->nEntries != origNColorPalettes) {
    e = dirReplaceOriginal(cpDirP, "ColorPalette", verbose);
  }
  else if (verbose) {
    printf("\nNo new palettes to write.\n");
  }
  if (!e && cmDirP->nEntries != origNColormaps) {
    e = dirReplaceOriginal(cpDirP, "Colormap", verbose);
  }
  else if (verbose) {
    printf("\nNo new colormaps to write.\n");
  }

  return e;
}
