#include "body.h"

/* 
 * Passed-in arguments: name of bod[y|ies].
 */
int main(int argc, char ** argv) {
  char *srcFilePath;
  Database *cpDbP, *cmDbP;
  U32 origNColorPalettes, origNCollisionTypes, origNColormaps;
  cpDbP = cmDbP = NULL;

  // Verbose 
  U8 verbose = 0;

  // Databases
  Error e = dbGet(&cpDbP, "ColorPalette", argc, verbose);
  if (!e) {
    e = dbGet(&cmDbP, "Colormap", argc, verbose);
  }
  if (!e) {
    origNColorPalettes = cpDbP->nEntries;
    origNColormaps = cmDbP->nEntries;
    origNColorPalettes = origNColormaps = 0;
  }

  // Write all the bodies.
  for (U32 i = 1; !e && i < argc; ++i) {
    if (!strcmp(argv[i], "-v")) {
      verbose = 1;
      continue;
    }
    // Colormap and Color palette (autogenerated)
    e = getSrcFilePath(&srcFilePath, "Body/Graybody/Colormap", argv[i], ".png"); 
    if (!e) {
      e = img(srcFilePath, cpDbP, cmDbP, verbose);
    }
    jbFree((void**) &srcFilePath);
    // Animation
    Animation *animP = NULL;
    if (!e) {
      e = getSrcFilePath(&srcFilePath, "Body/Graybody/Animation", argv[i], ".json"); 
    }
    if (!e) {
      e = anim(srcFilePath, verbose, &animP);
    }
    jbFree((void**) &srcFilePath);
    // Collision
    if (!e) {
      e = getSrcFilePath(&srcFilePath, "Body/Graybody/Collision", argv[i], "_col.png"); 
    }
    if (!e) {
      e = coll(srcFilePath, argv[i], 0, animP, verbose);
    }
    jbFree((void**) &animP);
    jbFree((void**) &srcFilePath);
    // Genome
    // Seed
  }

  // Save the updated palette directory AFTER all updates are done.
  if (!e && cpDbP->nEntries != origNColorPalettes) {
    e = dbReplaceOriginal(cpDbP, "ColorPalette", verbose);
  }
  else if (verbose) {
    printf("\nNo new palettes to write.\n");
  }
  if (!e && cmDbP->nEntries != origNColormaps) {
    e = dbReplaceOriginal(cpDbP, "Colormap", verbose);
  }
  else if (verbose) {
    printf("\nNo new colormaps to write.\n");
  }

  return e;
}
